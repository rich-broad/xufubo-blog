# 引言
在互联网发展初期，需要处理的信息量非常有限，通常情况下，单台机器可以处理所有的数据。随着移动互联网的快速发展，需要处理的数据量在飞速增长。这时单机已无法处理这些数据，分布式系统应用而生。分布式系统是由一些独立的计算机通过网络和分布式中间件连接起来的系统。这个系统允许这些独立的计算机能够协同它们的活动来分享整个系统的资源，对于用户来看，整个系统只是一个单独的计算机。  
任何一个系统，数据库都是这个系统的基石，同样随着移动互联网的发展，传统的单机数据库已经无法满足需求，在这种情况下为了提高数据库的写容量，需要将数据按照某种规则水平分片，为了提高读性能，通常通过复制技术，使得数据存在多个副本来提高读性能，比如mysql的主从复制，但是mysql的主从复制存在一系列的问题，比如：当主站发生故障时，切换到从站，从站会有数据延迟，加入复制拓扑比较复杂导致扩展性不是很好，即使是半同步主从复制，主从之间的数据任然可能不一致（具体的分析在mysql复制一章中深入分析），等等，mysql组复制正是为了解决这些问题。  
mysql组复制(MySQL Group Replication) 是在mysql5.7.17 GA版中发布的新特性。是一个全新的高可用与高可扩展的解决方案。mysql组复制提供了：高可用，高扩展，高可靠，高一致性，高容错性的集群服务。  
 - 高容错性：只要不是大多数节点坏掉就可以继续工作，具有自动检测机制，当不同的节点产生资源争用冲突时，不会出现错误，按照先到者优先原则进行处理，并内置了自动化脑裂防护机制。  
 - 高扩展性：节点的增加和移除都是自动的，新节点加入后，会自动从其他节点上同步状态，直到新节点和其他节点一致，如果某节点移除了，其他节点会自动更新组信息。不需要人工去维护和干预，传统的主从复制做不到这点。  
 - 高一致性：基于paxos协议和原生复制以插件的方式保证了多节点数据副本的一致性。   
 - 高可用性：基于paxos协议和原生复制，mysql组复制提供了单主和多主模式，保证了高可用性。  
我觉得mysql组复制是在数据库方面高可用和高扩展方面的一个趋势，因此这里详细研究和学习。以下的学习基本都是基于mysql 8.0的手册，加上自己的一些理解。  

## 1、组复制背景
本节提供MySQL组复制的背景信息。  
我们知道，创建高可用、高容错系统的常见方法是采用冗余组件，换句话说，组件可以被删除，而系统任然可以按照预期执行。这会产生一系列的挑战，将这类系统的复杂性提高到了完全不同的水平。具体来说，对于数据库而言，需要管理和维护多个服务器而非一个。而且，这些服务器之间需要协作，这就需要处理经典的分布式系统问题，比如：网络分区、脑裂等。  
因此，最大的挑战是将数据库和数据复制的逻辑与若干个数据库服务以简单一致的方式协调运行的逻辑相融合。换句话说，也就是使多个服务器成员关于系统的状态和系统每次变更的数据保持一致。这可以被概括为时多个服务对于每个数据库状态的转换达成共识，从而使它们都作为一个独立的数据库运行，或者说它们最终达到相同状态。这意味着它们要作为分布式状态机运行。  
mysql组复制提供了一种强大的数据库服务间协调机制的分布式状态机复制。组中的服务成员之间会自动的进行协调。组复制可以运行在两种模式下，单主模式下，组复制具有自动选组功能，只有一台服务器接受更新；在多主模式下，所有的服务均可接受更新，不过对于多主模式，会有一定的限制（后边学习），这些需要应用程序去解决。  
内置的组成员服务用于保持组视图的一致性，并在任何给定的时间点对于所有的服务均可用。当服务加入或者离开组时，组视图会随之更新(故障检测可以确保在服务离开组时通知组成员服务来维护最新的视图)。这些都是自动的。  
对于要提交的事务，决定提交或终止事务是由每个服务单独完成的，但所有组成员必须就该事务在全局事务序列中的顺序达成一致意见。如果存在网络分区，造成组成员之间无法通信而不能达成一致协议，系统在此问题解决前将不会继续运行(因为继续运行会导致组内成员服务间数据不一致)，因此，组复制还提供了一个脑裂保护机制。  
这些机制都是由系统提供的组通信协议提供支持的。该协议提供了故障检测机制、组成员资格服务以及安全且完全有序的消息传递。所有这些特性都是创建一个系统的关键，它可以确保数据在整个服务器组中持续复制。该技术的核心是Paxos算法的实现。它充当组的通信引擎。  

### 1.1 复制技术
在深入了解MySQL组复制的细节之前，本节介绍一些背景概念和组复制如何运行的概观。这提供了一些信息来帮我们助理解组复制所需的内容以及mysql经典的异步复制和组复制之间的区别。  
#### 1.1.1 主-从复制
传统的MySQL复制提供了一种简单的主-从复制方法。有一个主机和一个或者多个从机。主用来更新，执行事务，提交它们，然后将这些更新异步的发送到从机。它是一个无共享系统，所有服务器默认都有完整的数据副本。  
此过程如下：  
![MySQL异步复制](https://dev.mysql.com/doc/refman/8.0/en/images/async-replication-diagram.png)  
还有半同步复制，它向协议添加了一个同步步骤。即：主站在提交事务时需要等待从站确认它已收到事务。只有这样主才能提交该事务。  
![MySQL半同步复制](https://dev.mysql.com/doc/refman/8.0/en/images/semisync-replication-diagram.png)  

#### 1.1.2 组复制
组复制是一种可用于实现容错系统的技术。复制组是一组通过消息传递彼此交互的服务器。通信层提供了原子消息、完全有序消息交互等的保障。这些非常强大的属性可以转化为非常有用的抽象，可以帮助我们构建更高级的数据库复制解决方案。  
mysql组复制建立在这些属性和抽象的基础之上，实现了基于复制协议的多主更新。复制组由多个服务成员构成，并且组中的每个成员可以独立地执行事务。但所有读写事务需要经过该组的协调批准（冲突检测）后才能提交。只读事务则立即提交。换句话说，对于读写事务，提交操作并不是由始发成员服务单向决定的，而是由组来决定的。准确的说，在始发成员上，当事务准备好提交时，该成员以原子方式广播写入值(已改变的行)和对应的写入集（已更新行的唯一标识符）。然后会为该事务建立一个全局的id，最终，这意味着所有服务成员以相同的顺序接收同一组事务。因此，所有服务成员以相同的顺序应用相同的更改，以确保组内一致。  
组内，在不同的成员上并发执行的事务可能存在冲突。根据组复制的冲突检测机制，将对两个不同的并发事务的写集合进行检测。如果在不同的成员上执行两个更新同一行的并发事务，则会出现冲突，排在最前面的事务可以在所有成员上提交，第二个事务在源服务上回滚，并在组内的其他服务上删除。这就是分布式的先提交当选原则。  
![mysql组复制](https://dev.mysql.com/doc/refman/8.0/en/images/gr-replication-diagram.png)  
组复制是一种无共享(share-nothing)复制方案，组内每个服务成员都有完整的数据副本。  
**注意**：上图略去了基本共识和Paxos相关的信息。  

### 1.2 组复制使用案例
组复制使我们可以根据在一组服务中复制系统的状态来创建具有冗余组件的高可用高容错系统。因此，在组内，只要不是全部或者大多数(一半及以上)服务发生故障，系统任然可用。最多只是性能和可伸缩性降低，但它任然可用。服务故障是孤立并且独立的。它们由**组成员服务**来监控，组成员服务依赖于分布式故障检测系统，其能够在任何服务自愿的或由于意外停止而离开组时发出信号。通过一个分布式恢复程序来确保当有一个服务加入组时它们会自动更新组信息。并且多主更新确保即使在单个服务器故障的情况下也不会阻止更新，不必进行故障转移。因此mysql组复制保证了数据库服务持续可用。  
值得注意的是，尽管数据库服务可用，但当有一个服务崩溃时，连接到它的客户端必须重定向或者故障转移到不同的服务上。这不是组复制要解决的问题。连接器、负载均衡器、路由系统等中间价更适合处理这个问题。  
#### 1.2.1 使用场景举例
以下示例是组复制的典型使用场景：  
 - 弹性复制-需要非常流畅的复制基础架构环境，其中的服务数量必须动态增长或者收缩，并尽可能减少副作用。例如：云数据库。  
 - 高可用分片-数据分片是实现写扩展的常用技术。使用mysql组复制实现高可用分片，其中每个分片映射到一个组。  
 - 替代主从复制-在某些情况下，使用单个主服务器会造成单点争用和单点故障，写入整个组可能更具扩展性。  
 - 自主系统-可以将组复制直接部署到已有复制协议的自动化系统中。  

### 1.3 组复制详细信息
本节介绍有关组复制构建的详细信息。  

#### 1.3.1 故障检测
组复制提供了故障检测机制



