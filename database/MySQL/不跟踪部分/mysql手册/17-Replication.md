# 复制
冗余是高可用的基石，mysql也不例外，通过复制实现mysql的高可用，本章学习mysql复制相关的知识。  
复制功能可将来自一台mysql数据库服务器（主服务器）的数据复制到一台或多台mysql数据库服务器（从服务器）。默认情况下复制是***异步***的; 从库不需要永久连接以接收来自主库的更新。根据配置，你可以复制数据库中的所有数据库、选定数据库、甚至选定的表。用好mysql的复制技术，不仅可以提高mysql服务器的可用性，还可以提高应用的整体性能。    
mysql的复制具有如下优点：  
 - 横向扩展解决方案 - 将负载分散到多个从站以提高性能。这种架构中，写入和更新必须在主服务器上进行。
 - 数据安全性 - 因为数据被复制到从库，并且从库可以暂停复制过程，所以可以在从库上运行备份服务而不会破坏相应的主数据。  
 - 数据分析 - 可以在主库上创建实时数据，而信息分析可以在从库上进行，而不会影响主库的性能。  
 - 远程数据分发 - 你可以使用复制为远程站点创建本地数据副本。  
mysql8.0支持不同的复制方法，既支持传统的基于从主站的二进制日志中复制事件，并要求主站和从站之间的日志文件和位置同步，又支持基于全局事务标识符（GTID）的方法，该方法是事务性的，而且不需要使用日志文件的位置，这种方式大大简化了许多常见的复制任务。  
mysql8.0支持不同的同步类型，既有原始的单向异步复制，又支持半同步复制。此外mysql8.0还支持延迟复制。
有两种核心类型的复制格式：复制整个SQL语句的基于语句的复制（SBR）和仅复制已更改行的基于行的复制（RBR）。你还可以使用第三种混合的格式（MBR）。

## 1、配置复制
### 1.1 基于二进制日志文件位置的复制配置概述
作为主站的mysql数据库会将更新和更改作为***事件***写入二进制日志（binlog）。作为从站的mysql数据库会从主站读取二进制日志，并在从站中执行二进制日志中的事件。每个从站都会接受到二进制日志中的***全部内容***，你可以配置从站，来控制从站仅处理特定数据库或者表事件，不过你无法控制主站，主站会在二进制日志中记录全部事件。  
每个从站都会保存二进制日志坐标的数据：日志文件的名字和已经处理的日志文件的位置。这意味着可以将多个从站连接到主站并执行相同二进制日志的不同部分，从站可以断开与主站的连接，恢复后可以继续复制，而不影响主站的运行。  
主站和每个从站必须配置一个唯一的ID（server-id选项）。因为每个从站要主动去和主站建立连接，因此，每个从站必须配置有关主站名称，日志文件名以及该文件中的位置的信息（**即，从站要知道从哪里开始复制**）。这些信息可以在从站上使用CHANGE MASTER TO进行控制。  

### 1.2 设置基于二进制日志文件位置的复制
有多种设置方法，具体使用什么方法取决于你如何设置复制以及主站数据库中是否有数据。不过有一些设置是通用的：  
 - 确保主站配置了唯一的id，启用了二进制日志记录。  
 - 确保每个从站配置了唯一的id。  
 - 在主服务器上创建一个单独用于复制的账户，以便从站使用这个账户来连接主站。  
 - 在创建数据快照或启动复制过程之前，在主数据库上应记录二进制日志中的当前位置。在配置从站时需要此信息，以便从站知道从二进制日志内的哪个位置开始执行事件。  
 - 如果主站上已经有数据并希望使用它来同步从站，则需要创建数据快照以将数据复制到从站。正在使用的存储引擎会影响你创建快照的方式。如果使用的是myisam，则必须停止主站上的语句，或者读锁，然后获取其当前二进制日志坐标并转储其数据，然后再允许主站继续执行语句。如果不停止语句的执行，数据转储和主站状态信息将不匹配，从而导致从服务器上的数据库不一致或损坏。如果使用InnoDB则不需要读锁，一个足够长的传输数据快照的事务就可以了，更多信息见[Section 15.18, “InnoDB and MySQL Replication](https://dev.mysql.com/doc/refman/8.0/en/innodb-and-mysql-replication.html)。  
 - 用主站的相关信息配置从站，例如：主机名，登录凭证和二进制日志文件的名称和位置。  
 > - **注意：设置过程中的某些步骤需要 SUPER特权。如果您没有此权限，则可能无法启用复制。**  
如上是基于二进制日志位置进行复制的基本配置。  

#### 1.2.1 设置主站配置
通过--log-bin选项启用二进制日志，并设置二进制日志文件的基本名称。建议你指定此选项以为二进制日志文件指定非默认基本名称（因为默认值为主机名，当服务器主机名改变之后可能会出问题，因此要设置）。  
通过--server-id设置服务器唯一id（范围是1~2^32 - 1）。如果在主站上设置服务器ID为0，则会拒绝从站的任何连接，如果在从站上设置服务器ID为0，则拒绝连接到主站。
 > **注意：以下选项也对主站有影响**
  - 对于InnoDB，为了最大程度（为什么不是完全，后边分析）的保持持久性和一致性，你要在主站的my.cnf中设置如下两个选项：  
  innodb_flush_log_at_trx_commit=1 和 sync_binlog=1 。
  - 确保复制主站上未启用 skip-networking选项。  

#### 1.2.2 设置从站配置
通过--server-id设置服务器唯一id，例如：  
```
[mysqld]
server-id=2
```
如果你要设置多个从站，则每个从站都必须具有唯一的非零server-id值，该值不同于主站和任何其他从站的值。  
默认情况下，二进制日志记录在**所有**服务器上是启用的。一般而言，从站不需要启用二进制日志记录，不过启用二进制日志的从站可以构建更加复杂的复制拓扑结构。例如：  
```
A -> B -> C
```
这时，B既是主站又是从站。B从A接收的更新必须由B记录到其二进制日志中，以便传递给C。这时，B除了启用二进制日志之外，此复制拓扑还需要启用--log-slave-updates选项，使用此选项，从站不仅写入从主站接收到的更新，同时通过从机的SQL线程将更新写到到从机自己的二进制日志中。--log-slave-updates选项默认启用。  
如果你需要在从站上禁用二进制日志和从站更新日志，则可以通过为从站指定--skip-log-bin 和 --skip-log-slave-updates 选项。  

#### 1.2.3 创建一个复制用户
在复制架构中，每一个从站会使用mysql用户名和密码连接到主站，因此，主站上必须有一个账户用于从站的复制。任何被授予REPLICATION SLAVE权限的账户都可以用于复制。在设置复制从站时，用户名由CHANGE MASTER TO命令中的MASTER_USER选项指定。  
虽然你不必专门为复制创建一个账户，但是，你应该知道复制用户的用户名和密码以纯文本形式存储在主站信息存储库的mysql.slave_master_info表中，因此，为了安全起见，你还是要创建一个仅具有复制权限的单独帐户。  
例如：  
```sql
mysql> CREATE USER 'repl'@'%.example.com' IDENTIFIED BY 'password';
mysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%.example.com';
```

#### 1.2.4 获取主站的二进制日志坐标
要将从站配置为在正确的位置启动复制过程，需要记录主站在其二进制日志中的当前坐标。此过程使用FLUSH TABLES WITH READ LOCK，它会阻止InnoDB表的COMMIT操作。  
要获取主站二进制日志坐标，请按照下列步骤进行：  
 - 1、启动客户端，连接主站，执行如下语句：
 ```sql
 FLUSH TABLES WITH READ LOCK;
 ```
 **注意：让你发出FLUSH TABLES WITH READ LOCK语句的客户端保持运行，以便读锁保持有效。如果退出客户端，则锁定被释放。**  
 - 2、启动一个新的会话，连接主站，使用SHOW MASTER STATUS语句确定当前主站的二进制日志文件名称和位置：  
 ```sql
 mysql > SHOW MASTER STATUS;
 +------------------+----------+--------------+------------------+
 | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
 +------------------+----------+--------------+------------------+
 | mysql-bin.000003 | 73       | test         | manual,mysql     |
 +------------------+----------+--------------+------------------+
 ```
 你需要记录：mysql-bin.000003和73，一会设置从站需要他们。  
 如果主站之前在禁用二进制日志记录的情况下运行，由SHOW MASTER STATUS或mysqldump --master-data显示的日志文件名称和位置值将为空。在这种情况下，稍后在指定从站的日志文件和位置时需要使用的值是空字符串（''）和4。  
这时候你有了正确的二进制日志坐标。接下来的步骤取决于主站上是否已经存在数据。 
 - 如果复制之前，主站上已经存在数据，则需要先将数据同步到主站，这时需要保持刚刚的客户端运行，以***保持锁定***状态，以避免进一步的更改（见下一节）。  
 - 如果设置新的主从复制组，则可以退出第一个会话以释放读锁。  

#### 1.2.5 选择数据快照的方法
如果主站已经存在数据，则需要先将数据复制到各个从站。有多种方法可以从主站转储数据。  
通常情况下有以下两种：  
 - 1、使用mysqldump工具来创建您想要复制的所有数据库的转储。这是推荐的方法，尤其是使用InnoDB时。  
 - 2、如果您的数据库存储在二进制可移植文件中，则可以将原始数据文件复制到从站。这可以比使用mysqldump并在每个从属设备上导入文件更高效。对于像InnoDB这样的存储引擎，这是不推荐的。  

***使用mysqldump创建数据快照***  
先使用mysqldump工具转储主站数据，在开始复制之前将该数据导入从站中。  
以下示例将所有数据库转储到名为dbdump.db的文件，并包含--master-data选项，它会自动附加从站上所需的CHANGE MASTER TO语句以启动复制过程：  
```shell
shell> mysqldump --all-databases --master-data > dbdump.db
```
 > **注意：如果不使用--master-data，则需要手动将所有表锁定在单独的会话中。如上一小节那样**  
你也可以使用mysqldump转储你需要的数据库或者表，有关更多信息，见[4.5.4 mysqldump — A Database Backup Program](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html)。  
要导入数据，请将转储文件复制到从站，或者在远程连接到从站时从主站访问该文件。  

***使用原始数据文件创建数据快照***  
该方法个人阅读了mysql8.0的官方手册，感觉不是很好，在此不再详细列出，具体的可以参考mysql的官方手册。  

通过这一小节的学习，我们会看到：最好在一开始就规划好自己的复制拓扑，而不要等着主站运行了一段时间后才开始规划，这样会很麻烦，搞不好，也容易出错。  

#### 1.2.6 设置从站
经过前面的准备，我们已经做了如下工作：  
 - 1、为主站设置了server-id，
 - 2、为主站开启了相关的选项；
 - 3、创建好了账户；
 - 4、获取了主站数据的快照和此快照对应的二进制坐标；
这时候，需要执行如下步骤：
 - 1、在主站上释放所有表的读锁：
 ```sql
 UNLOCK TABLES;
 ```
 - 2、按照上边介绍的方法配置从站；
 - 3、接下来的步骤取决于是否需要有现成的数据导入到从站。  

***使用新的主站和从站设置复制***  
如果没有要导入的以前数据库的快照，请将从站配置为从新主站启动复制。  
要设置主站和从站的复制，请执行以下操作：
 - 1、启动从站mysql服务器；  
 - 2、执行CHANGE MASTER TO设置主站的信息；  
 如果你需要将已dump的数据加载到新搭建的复制组中，那么你可以先配置好复制拓扑，然后通过将数据加载到新的主站中，数据会自动复制到从站。  
 ```shell
 shell> mysql -h master < fulldb.dump
 ```

***使用现有数据设置复制***  
使用现有数据设置复制时，请在开始复制之前将快照从主站传输到从站。将数据导入从站的过程取决于你获得快照的方法（见上一小节）  
**如果你使用mysqldump：**  
 - 1、使用--skip-slave-start选项启动从站，以便复制不会启动。  
 - 2、导入由mysqldump生成的转储文件：  
 ```shell
 shell> mysql < fulldb.dump
 ```
 这里我们假设mysqldump使用了--master-data生成转储文件。  

**如果使用原始数据文件创建快照：**  
 - 1、将数据文件解压缩到从站数据目录中。例如：  
 ```shell
 shell> tar xvf dbdump.tar
 ```
 - 2、使用--skip-slave-start选项启动从站 以便复制不会启动。  
 - 3、使用主站的复制坐标配置从站（CHANGE MASTER TO语句）。  
 - 4、启动从属线程：  
 ```sql
 mysql> START SLAVE;
 ```
完成此过程后，从站连接到主站并复制自从创建快照以来在主站上发生的任何更新。如果出于任何原因无法复制，错误消息将发送到从站的错误日志中。  






主站的一个快照足以满足多个从机的需求。要设置更多的从站，请使用相同的主站快照，并按照上述过程的从站部分进行操作。  


