# 优化
## 引言
对系统性能的优化是每一个工程师孜孜不倦追求的目标，现在随着数据量爆炸式的增长，一个系统的架构越来越复杂，几乎每一个系统都是分布式系统，每一个系统都分为多个层次，为了提高系统性能，系统中存在大量的缓存。目前来看，一个系统大概分为如下几层：
 - 接入层
 - 逻辑层
 - cache层（redis、memcahed等）
 - 持久层（mysql集群、分布式文件系统等）。
每一层都需要做优化，系统的性能瓶颈取决于性能最低的地方。接入层通常来说主要是负载均衡和命令字转发的功能。就是网络包的透传，而且可以很容易的实现线性扩展。逻辑层通常基于RPC，也可以很容易的线性扩展，cache层，通常是对内存的直接操作，速度很快，而且通过k-v可以很容易的做到分布式，最为复杂麻烦的就在于持久层。这一层通常难以扩展，而且对于数据库而言，也有很多点可以优化。现在互联网企业多用mysql集群作为持久层。掌握好mysql的优化，将变得很有意义。接下来探讨和学习mysql的优化，接下来的内容主要来自mysql8.0的官方手册，也会有自己的一些理解。   

本章主要谈论如下几个方面：  
1. 优化概述  
2. 优化SQL语句
3. 优化和索引
4. 优化数据库结构
5. 优化InnoDB表
6. 优化MyISAM表
7. 优化MEMORY表
8. 了解查询执行计划
9. 控制查询优化器
10. buffer和cache
11. 优化锁定操作
12. 优化MySQL服务器层
13. 衡量性能（基准测试）
14. 检查线程信息

 ## 1 优化概述
 优化是一门很大的学问，而且涉及到方方面面不同层次的优化。而且不同的角色，优化关注的点不尽相同。你可以例如，对于DBA而言，优化服务器的配置（缓存区、线程数等）、与开发人员一起优化表的设计，根据业务，配置合适的复制等就非常重要，对于开发人员，不仅要和DBA讨论业务，设计出合理的表结构，数据类型，同时，也需要理解mysql的查询执行，优化器的优化程度，依据业务特点设计合理的索引等。接下来就学习mysql优化的方方面面。
数据库的性能取决于数据库各个级别的因素，如：配置、表设计、查询语句等。在处理数据库性能时，应该首先掌握**基本的规则和准则**，随着学习的深入，再去了解内部发生的事情，这时候，就需要深入到源码级别进行优化。
一般的用户旨在从现有的软件和硬件配置中获得最佳的数据库性能。高级用户通常需要结合自己的业务，改进MySQL软件本身（例如国内的bat都需要定制和改造mysql，因为现有的软件无法满足业务需求），或者开发自己的存储引擎和硬件设备来扩展MySQL生态系统。
对于优化通常有如下几点：
 - 数据库级别的优化
 - 硬件级别的优化
 - 在可移植性和性能之间平衡
### 数据库级别的优化
使数据库应用程序加快的最重要因素是其基本设计：
 - 表结构设计是否合理？数据类型是否正确？
 - 正确的索引舍否建立？
 - 选择的存储引擎是否合理？
 - 表格是否使用合适的行格式？
 - 应用程序是否使用合适的锁策略？例如，在可能的情况下允许共享访问，以便数据库操作可以并发运行，在适当时请求独占访问，从而使关键操作成为最高优先级。同样，存储引擎的选择也很重要。 InnoDB存储引擎可处理大多数锁问题，而无需您的参与，从而实现数据库更好的并发性并减少代码的实验和调整量。
 - 内存缓冲区配置是否合理？主要涉及到InnoDB的缓冲池和MyISAM的key缓存。
 - 线程数的设置是否合理？
 - 依据业务的特点，事务的隔离级别选择是否合理？
 - 复制设置是否合适？

### 硬件级别的优化
随着数据库变得越来越繁忙，任何数据库应用程序最终都会遇到硬件限制。DBA必须评估是否可以调整应用程序或重新配置服务器以避免这些瓶颈，或者是否需要更多硬件资源。系统瓶颈通常来自这些：
 - 磁盘寻到，对于磁盘而言，主要是寻道时间，新的次磁盘也不会有数量级上的提升，因此，对于磁盘的优化，优化查找时间的方法是将数据分配到多个磁盘上，通过并行处理来提高。
 - 磁盘的读取和写入，也可以通过多个磁盘并行读取来优化。
 - CPU时钟周期，当数据在内存中时，我们必须对其进行处理以得到我们的结果。与内存数量相比，大表是最常见的限制因素。但对于小表，速度通常不是问题。
 - 内存带宽，当CPU需要的数据量超过CPU缓存容量时，内存带宽就成为瓶颈。对大多数系统来说，这是一个罕见的瓶颈，但需要注意的一个瓶颈。

 ### 在可移植性和性能之间平衡
为了使用mysql特有的性能，又为了使应用程序具有可移植性，你可以将mysql特定的关键字包含在/*! */中，其他的SQL服务器会忽略这些注释。
通常情况下，对于一个软件工程师而言，硬件级别的优化通常不可控，但是数据库级别的优化却是完全可以的，通常也是优化的重点，接下来着重学习数据库级别的优化。
